<script lang="ts">
	import type { AcceptedChallenge, ChallengeV2, ImageSource } from '$lib/types/challenges';
	import type { Writable } from 'svelte/store';
	import { getImageUrlFromChallenge, randomIntBetween } from '$lib/util';
	import { goto } from '$app/navigation';
	import { page } from '$app/stores';
	import {
		getChallengeState,
		getChallengeUserData,
		instanceOfChallengeAccept,
		instanceOfChallengeBookmark,
		instanceOfChallengeComplete,
		instanceOfChallengeReject,
		type ChallengeInteraction
	} from '$lib/services/challenge-storage';
	import SuperChallengeIcon from '../impact/super-challenge-icon.svelte';
	import { getSuperChallengeDataForLeadChallenge } from '../impact/super-challenge';
	import { onMount } from 'svelte';

	export let challenge: ChallengeV2;
	// let challengeStatePromise = getChallengeState(challenge.slug);
	export let challengeState;
	let imageUrl = getImageUrlFromChallenge(challenge, true);
	// $: {
	// 	// imageUrl = challenge.image != 'imageUrl' ? challenge.image?.file?.path ?? undefined : undefined;
	// 	imageUrl = getImageUrlFromChallenge(challenge);
	// 	// console.log('image', challenge.image?.file?.path, $page.url);
	// }
	export let isHidden: (ChallengeV2) => boolean = (challenge) => false;
	export let tags = {};
	export let isRecommendation = false;
	// console.log(tags);
	const challengeStatusTag = (status: string) => {
		if (status !== '') {
			status = status.toLowerCase().trim();
			if (status.startsWith('fertig')) {
				return '';
			} else {
				return '*';
			}
		}
		return '*';
	};

	let superChallenge = challenge.lead
		? getSuperChallengeDataForLeadChallenge(challenge.slug)
		: undefined;

	onMount(async () => {
		if (!challengeState) {
			challengeState = await getChallengeState(challenge.slug);
		}
	});
</script>

<div
	class:hidden={isHidden(challenge)}
	class="ch-card-sharp shadow-storm-light animate-fadeInBlur flex  bg-image  relative bg-opacity-30
				{instanceOfChallengeReject(challengeState) ? 'bg-red-500 shadow-red-500' : ''}
				{instanceOfChallengeBookmark(challengeState) ? 'bg-yellow-500 shadow-yellow-500' : ''}
				{instanceOfChallengeComplete(challengeState) ? 'bg-green-500 shadow-green-500' : ''}
				{instanceOfChallengeAccept(challengeState) ? 'bg-nature shadow-nature' : ''}
				"
	style={`--bg-image: url(${imageUrl})`}
	on:click={async () => {
		if (isRecommendation) {
			//FIXME make this not navigate back
			await goto(`/challenges`);
			setTimeout(() => goto(`/challenge/${challenge.slug}`), 200);
		} else {
			goto(`/challenge/${challenge.slug}`);
		}
	}}
>
	<div class="grid grid-flow-col place-content-between w-full">
		<span class=""
			>{challenge.Status ? challengeStatusTag(challenge.Status) : ''}{challenge.title}</span
		>
		{#await superChallenge then sc}
			{#if superChallenge}
				<div>
					<SuperChallengeIcon superChallenge={sc} cssClass={'challenge-card'} />
				</div>
			{/if}
		{/await}
	</div>

	<div
		class="grid grid-flow-row-dense place-content-end items-start justify-start w-full absolute inset-4 text-white rotate-6"
	>
		<svg
			width={instanceOfChallengeAccept(challengeState) ? 40 : 31}
			height="40"
			viewBox="0 0 {instanceOfChallengeAccept(challengeState) ? 40 : 31} 40"
			fill="none"
			xmlns="http://www.w3.org/2000/svg"
		>
			{#if instanceOfChallengeReject(challengeState)}
				<path
					stroke-linecap="round"
					stroke-linejoin="round"
					d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"
				/>
			{:else if instanceOfChallengeBookmark(challengeState)}
				<path
					d="M0.5 5C0.5 3.67392 1.02678 2.40215 1.96447 1.46447C2.90215 0.526784 4.17392 0 5.5 0L25.5 0C26.8261 0 28.0979 0.526784 29.0355 1.46447C29.9732 2.40215 30.5 3.67392 30.5 5V38.75C30.4999 38.9761 30.4384 39.1979 30.3222 39.3919C30.206 39.5858 30.0393 39.7446 29.84 39.8513C29.6407 39.9581 29.4161 40.0087 29.1903 39.9979C28.9644 39.9871 28.7457 39.9153 28.5575 39.79L15.5 32.7525L2.4425 39.79C2.25426 39.9153 2.03558 39.9871 1.80973 39.9979C1.58388 40.0087 1.35933 39.9581 1.16 39.8513C0.960665 39.7446 0.79401 39.5858 0.677785 39.3919C0.56156 39.1979 0.500117 38.9761 0.5 38.75V5ZM5.5 2.5C4.83696 2.5 4.20107 2.76339 3.73223 3.23223C3.26339 3.70107 3 4.33696 3 5V36.415L14.8075 30.21C15.0127 30.0735 15.2536 30.0006 15.5 30.0006C15.7464 30.0006 15.9873 30.0735 16.1925 30.21L28 36.415V5C28 4.33696 27.7366 3.70107 27.2678 3.23223C26.7989 2.76339 26.163 2.5 25.5 2.5H5.5Z"
					fill="currentColor"
				/>
				<path
					d="M15.5 10C15.8315 10 16.1495 10.1317 16.3839 10.3661C16.6183 10.6005 16.75 10.9185 16.75 11.25V15H20.5C20.8315 15 21.1495 15.1317 21.3839 15.3661C21.6183 15.6005 21.75 15.9185 21.75 16.25C21.75 16.5815 21.6183 16.8995 21.3839 17.1339C21.1495 17.3683 20.8315 17.5 20.5 17.5H16.75V21.25C16.75 21.5815 16.6183 21.8995 16.3839 22.1339C16.1495 22.3683 15.8315 22.5 15.5 22.5C15.1685 22.5 14.8505 22.3683 14.6161 22.1339C14.3817 21.8995 14.25 21.5815 14.25 21.25V17.5H10.5C10.1685 17.5 9.85054 17.3683 9.61612 17.1339C9.3817 16.8995 9.25 16.5815 9.25 16.25C9.25 15.9185 9.3817 15.6005 9.61612 15.3661C9.85054 15.1317 10.1685 15 10.5 15H14.25V11.25C14.25 10.9185 14.3817 10.6005 14.6161 10.3661C14.8505 10.1317 15.1685 10 15.5 10Z"
					fill="currentColor"
				/>{:else if instanceOfChallengeBookmark(challengeState)}
				<path
					d="M0.5 5C0.5 3.67392 1.02678 2.40215 1.96447 1.46447C2.90215 0.526784 4.17392 0 5.5 0L25.5 0C26.8261 0 28.0979 0.526784 29.0355 1.46447C29.9732 2.40215 30.5 3.67392 30.5 5V38.75C30.4999 38.9761 30.4384 39.1979 30.3222 39.3919C30.206 39.5858 30.0393 39.7446 29.84 39.8513C29.6407 39.9581 29.4161 40.0087 29.1903 39.9979C28.9644 39.9871 28.7457 39.9153 28.5575 39.79L15.5 32.7525L2.4425 39.79C2.25426 39.9153 2.03558 39.9871 1.80973 39.9979C1.58388 40.0087 1.35933 39.9581 1.16 39.8513C0.960665 39.7446 0.79401 39.5858 0.677785 39.3919C0.56156 39.1979 0.500117 38.9761 0.5 38.75V5ZM5.5 2.5C4.83696 2.5 4.20107 2.76339 3.73223 3.23223C3.26339 3.70107 3 4.33696 3 5V36.415L14.8075 30.21C15.0127 30.0735 15.2536 30.0006 15.5 30.0006C15.7464 30.0006 15.9873 30.0735 16.1925 30.21L28 36.415V5C28 4.33696 27.7366 3.70107 27.2678 3.23223C26.7989 2.76339 26.163 2.5 25.5 2.5H5.5Z"
					fill="currentColor"
				/>
				<path
					d="M15.5 10C15.8315 10 16.1495 10.1317 16.3839 10.3661C16.6183 10.6005 16.75 10.9185 16.75 11.25V15H20.5C20.8315 15 21.1495 15.1317 21.3839 15.3661C21.6183 15.6005 21.75 15.9185 21.75 16.25C21.75 16.5815 21.6183 16.8995 21.3839 17.1339C21.1495 17.3683 20.8315 17.5 20.5 17.5H16.75V21.25C16.75 21.5815 16.6183 21.8995 16.3839 22.1339C16.1495 22.3683 15.8315 22.5 15.5 22.5C15.1685 22.5 14.8505 22.3683 14.6161 22.1339C14.3817 21.8995 14.25 21.5815 14.25 21.25V17.5H10.5C10.1685 17.5 9.85054 17.3683 9.61612 17.1339C9.3817 16.8995 9.25 16.5815 9.25 16.25C9.25 15.9185 9.3817 15.6005 9.61612 15.3661C9.85054 15.1317 10.1685 15 10.5 15H14.25V11.25C14.25 10.9185 14.3817 10.6005 14.6161 10.3661C14.8505 10.1317 15.1685 10 15.5 10Z"
					fill="currentColor"
				/>
			{:else if instanceOfChallengeComplete(challengeState)}
				<path
					d="M17.66 0.115211C15.27 -0.482289 13.05 1.32521 12.89 3.66521C12.71 6.29271 12.315 8.70521 11.82 10.1402C11.5075 11.0402 10.6225 12.6727 9.22 14.2377C7.8275 15.7952 6.015 17.1827 3.8925 17.7627C2.2125 18.2202 0.5 19.6752 0.5 21.8002V31.8027C0.5 33.9152 2.205 35.4627 4.12 35.6652C6.795 35.9502 8.03 36.7027 9.29 37.4727L9.41 37.5477C10.09 37.9602 10.855 38.4177 11.835 38.7577C12.8275 39.0977 13.9875 39.3002 15.5 39.3002H24.25C26.5925 39.3002 28.2475 38.1077 29.085 36.6402C29.4898 35.9477 29.7085 35.1623 29.72 34.3602C29.72 33.9802 29.6625 33.5802 29.5275 33.2002C30.03 32.5427 30.4775 31.7552 30.7475 30.9477C31.0225 30.1227 31.1775 29.0427 30.7575 28.0752C30.93 27.7502 31.0575 27.4027 31.155 27.0677C31.3475 26.3927 31.4375 25.6477 31.4375 24.9252C31.4375 24.2052 31.3475 23.4627 31.155 22.7852C31.0675 22.4738 30.9521 22.1708 30.81 21.8802C31.2478 21.2574 31.5294 20.5385 31.6312 19.7841C31.733 19.0296 31.652 18.2618 31.395 17.5452C30.88 16.0652 29.69 14.7952 28.395 14.3652C26.2775 13.6602 23.8875 13.6752 22.105 13.8377C21.7349 13.871 21.3657 13.9127 20.9975 13.9627C21.8648 10.2487 21.8116 6.379 20.8425 2.69021C20.6739 2.09918 20.3505 1.56392 19.9057 1.13978C19.4609 0.715646 18.9109 0.418029 18.3125 0.277711L17.66 0.115211ZM24.25 36.8027H15.5C14.225 36.8027 13.3425 36.6302 12.65 36.3927C11.9475 36.1502 11.385 35.8227 10.71 35.4102L10.61 35.3502C9.2225 34.5027 7.615 33.5227 4.385 33.1802C3.5525 33.0902 3 32.4552 3 31.8052V21.8002C3 21.1652 3.565 20.4427 4.55 20.1752C7.2875 19.4252 9.4925 17.6852 11.085 15.9052C12.6725 14.1302 13.745 12.2177 14.18 10.9602C14.7875 9.21021 15.1975 6.54021 15.385 3.83521C15.4475 2.93021 16.285 2.35021 17.0525 2.54021L17.7075 2.70521C18.1075 2.80521 18.3525 3.06271 18.4275 3.34271C19.4485 7.23276 19.3226 11.3351 18.065 15.1552C17.9938 15.3677 17.9811 15.5954 18.028 15.8145C18.075 16.0336 18.1801 16.236 18.3321 16.4006C18.4842 16.5651 18.6777 16.6858 18.8924 16.75C19.1071 16.8141 19.3351 16.8194 19.5525 16.7652L19.56 16.7627L19.595 16.7552L19.74 16.7202C20.5949 16.5387 21.4597 16.4076 22.33 16.3277C23.9875 16.1777 25.9725 16.1927 27.605 16.7377C28.0425 16.8827 28.73 17.4877 29.03 18.3627C29.2975 19.1327 29.2475 20.0377 28.365 20.9177L27.4825 21.8002L28.365 22.6852C28.4725 22.7927 28.6275 23.0377 28.75 23.4727C28.87 23.8902 28.9375 24.3977 28.9375 24.9252C28.9375 25.4552 28.87 25.9602 28.75 26.3802C28.625 26.8152 28.4725 27.0602 28.365 27.1677L27.4825 28.0502L28.365 28.9352C28.4825 29.0527 28.6375 29.3777 28.3775 30.1552C28.1066 30.9092 27.6759 31.5957 27.115 32.1677L26.2325 33.0502L27.115 33.9352C27.13 33.9477 27.2175 34.0602 27.2175 34.3602C27.2064 34.7269 27.1023 35.0848 26.915 35.4002C26.5025 36.1202 25.6575 36.8002 24.25 36.8002V36.8027Z"
					fill="currentColor"
				/>
			{:else if instanceOfChallengeAccept(challengeState)}
				<path
					fill-rule="evenodd"
					clip-rule="evenodd"
					d="M25.8846 15.3648C26.001 15.4809 26.0934 15.6188 26.1564 15.7707C26.2194 15.9226 26.2519 16.0854 26.2519 16.2498C26.2519 16.4142 26.2194 16.577 26.1564 16.7289C26.0934 16.8807 26.001 17.0187 25.8846 17.1348L18.3846 24.6348C18.2685 24.7512 18.1306 24.8436 17.9787 24.9066C17.8268 24.9696 17.664 25.002 17.4996 25.002C17.3352 25.002 17.1724 24.9696 17.0205 24.9066C16.8687 24.8436 16.7307 24.7512 16.6146 24.6348L12.8646 20.8848C12.7484 20.7686 12.6562 20.6306 12.5933 20.4788C12.5304 20.3269 12.498 20.1642 12.498 19.9998C12.498 19.8354 12.5304 19.6727 12.5933 19.5208C12.6562 19.369 12.7484 19.231 12.8646 19.1148C12.9808 18.9986 13.1188 18.9064 13.2707 18.8435C13.4225 18.7806 13.5853 18.7482 13.7496 18.7482C13.914 18.7482 14.0767 18.7806 14.2286 18.8435C14.3804 18.9064 14.5184 18.9986 14.6346 19.1148L17.4996 21.9823L24.1146 15.3648C24.2307 15.2484 24.3687 15.156 24.5205 15.093C24.6724 15.03 24.8352 14.9976 24.9996 14.9976C25.164 14.9976 25.3268 15.03 25.4787 15.093C25.6306 15.156 25.7685 15.2484 25.8846 15.3648V15.3648Z"
					fill="currentColor"
				/>
				<path
					d="M25.6824 6.28244L23.3799 3.92244L25.1674 2.17744L26.7224 3.76994L28.9474 3.74244C29.9106 3.73104 30.8662 3.91234 31.7583 4.27566C32.6503 4.63899 33.4607 5.17701 34.1418 5.85809C34.8229 6.53917 35.3609 7.34956 35.7242 8.2416C36.0875 9.13363 36.2688 10.0893 36.2574 11.0524L36.2324 13.2774L37.8224 14.8324C38.5111 15.5054 39.0583 16.3092 39.4319 17.1966C39.8055 18.084 39.9979 19.0371 39.9979 19.9999C39.9979 20.9628 39.8055 21.9159 39.4319 22.8033C39.0583 23.6907 38.5111 24.4945 37.8224 25.1674L36.2299 26.7224L36.2574 28.9474C36.2688 29.9106 36.0875 30.8662 35.7242 31.7583C35.3609 32.6503 34.8229 33.4607 34.1418 34.1418C33.4607 34.8229 32.6503 35.3609 31.7583 35.7242C30.8662 36.0875 29.9106 36.2688 28.9474 36.2574L26.7224 36.2324L25.1674 37.8224C24.4945 38.5111 23.6907 39.0583 22.8033 39.4319C21.9159 39.8055 20.9628 39.9979 19.9999 39.9979C19.0371 39.9979 18.084 39.8055 17.1966 39.4319C16.3092 39.0583 15.5054 38.5111 14.8324 37.8224L13.2774 36.2299L11.0524 36.2574C10.0893 36.2688 9.13363 36.0875 8.2416 35.7242C7.34956 35.3609 6.53917 34.8229 5.85809 34.1418C5.17701 33.4607 4.63899 32.6503 4.27566 31.7583C3.91234 30.8662 3.73104 29.9106 3.74244 28.9474L3.76744 26.7224L2.17744 25.1674C1.48879 24.4945 0.941593 23.6907 0.567999 22.8033C0.194405 21.9159 0.00195312 20.9628 0.00195312 19.9999C0.00195312 19.0371 0.194405 18.084 0.567999 17.1966C0.941593 16.3092 1.48879 15.5054 2.17744 14.8324L3.76994 13.2774L3.74244 11.0524C3.73104 10.0893 3.91234 9.13363 4.27566 8.2416C4.63899 7.34956 5.17701 6.53917 5.85809 5.85809C6.53917 5.17701 7.34956 4.63899 8.2416 4.27566C9.13363 3.91234 10.0893 3.73104 11.0524 3.74244L13.2774 3.76744L14.8324 2.17744C15.5054 1.48879 16.3092 0.941593 17.1966 0.567999C18.084 0.194405 19.0371 0.00195312 19.9999 0.00195312C20.9628 0.00195312 21.9159 0.194405 22.8033 0.567999C23.6907 0.941593 24.4945 1.48879 25.1674 2.17744L23.3799 3.92244C22.9398 3.47191 22.4141 3.1139 21.8337 2.86948C21.2532 2.62506 20.6298 2.49914 19.9999 2.49914C19.3701 2.49914 18.7467 2.62506 18.1662 2.86948C17.5858 3.1139 17.06 3.47191 16.6199 3.92244L14.3199 6.28244L11.0199 6.24244C10.3904 6.2354 9.76577 6.35425 9.1828 6.59201C8.59982 6.82977 8.07024 7.18163 7.62516 7.62694C7.18009 8.07225 6.8285 8.60201 6.59105 9.18511C6.3536 9.76821 6.23507 10.3929 6.24244 11.0224L6.28244 14.3174L3.92244 16.6199C3.47191 17.06 3.1139 17.5858 2.86948 18.1662C2.62506 18.7467 2.49914 19.3701 2.49914 19.9999C2.49914 20.6298 2.62506 21.2532 2.86948 21.8337C3.1139 22.4141 3.47191 22.9398 3.92244 23.3799L6.28244 25.6799L6.24244 28.9799C6.2354 29.6095 6.35425 30.2341 6.59201 30.8171C6.82977 31.4001 7.18163 31.9296 7.62694 32.3747C8.07225 32.8198 8.60201 33.1714 9.18511 33.4088C9.76821 33.6463 10.3929 33.7648 11.0224 33.7574L14.3174 33.7174L16.6199 36.0774C17.06 36.528 17.5858 36.886 18.1662 37.1304C18.7467 37.3748 19.3701 37.5007 19.9999 37.5007C20.6298 37.5007 21.2532 37.3748 21.8337 37.1304C22.4141 36.886 22.9398 36.528 23.3799 36.0774L25.6799 33.7174L28.9799 33.7574C29.6095 33.7645 30.2341 33.6456 30.8171 33.4079C31.4001 33.1701 31.9296 32.8182 32.3747 32.3729C32.8198 31.9276 33.1714 31.3979 33.4088 30.8148C33.6463 30.2317 33.7648 29.607 33.7574 28.9774L33.7174 25.6824L36.0774 23.3799C36.528 22.9398 36.886 22.4141 37.1304 21.8337C37.3748 21.2532 37.5007 20.6298 37.5007 19.9999C37.5007 19.3701 37.3748 18.7467 37.1304 18.1662C36.886 17.5858 36.528 17.06 36.0774 16.6199L33.7174 14.3199L33.7574 11.0199C33.7645 10.3904 33.6456 9.76577 33.4079 9.1828C33.1701 8.59982 32.8182 8.07024 32.3729 7.62516C31.9276 7.18009 31.3979 6.8285 30.8148 6.59105C30.2317 6.3536 29.607 6.23507 28.9774 6.24244L25.6824 6.28244V6.28244Z"
					fill="currentColor"
				/>
			{/if}
		</svg>
	</div>

	<div
		class="grid grid-flow-row-dense place-content-end items-end justify-end w-full absolute inset-0"
	>
		<!-- {#each challenge.topic as topic} -->
		<!-- {#if tags[challenge.topic]} -->

		{#await tags then tagsResloved}
			{#each challenge.tags as tag}
				{#if challenge.impact === 'Big Point'}
					<div class="card_tag ">{tagsResloved[tag] ?? tag}</div>
				{:else}
					<div class="card_tag ">{tagsResloved[tag] ?? tag}</div>
				{/if}
			{/each}
		{/await}
		<!-- {/if} -->
		<!-- {/each} -->
	</div>
</div>

<style lang="scss">
	.fadedownin {
		animation-duration: 500ms;
		animation-delay: calc(var(--position) * 75ms);
		animation-name: fadedownin;
		animation-fill-mode: both;
		opacity: 0;
	}

	@keyframes fadedownin {
		from {
			opacity: 0;
			transform: translateY(-10px);
		}

		to {
			opacity: 1;
			transform: translateY(0px);
		}
	}

	.card .card-title::before {
		content: counter(card) '. ';
	}

	.card-2x2 {
		grid-column: span 2 / span 2;
		grid-row: span 2 / span 2;
		// justify-content: space-evenly;
		@apply text-xl;
	}

	.card-4x2 {
		grid-column: span 4 / span 4;
		grid-row: span 2 / span 2;
	}

	.card-4x4 {
		grid-column: span 4 / span 4;
		grid-row: span 4 / span 4;
	}

	.card-2x1 {
		grid-column: span 2 / span 2;
	}

	.card-1x2 {
		grid-row: span 2 / span 2;
		min-height: 200px;
	}

	.card_tag {
		white-space: nowrap;
		font-weight: 300;
		@apply text-[.6rem] text-black font-medium bg-gray-100 rounded-full my-[0.125rem] mx-1 px-1;
	}

	.card_tag_inverted {
		white-space: nowrap;
		font-weight: 300;
		@apply text-xs text-gray-600 bg-gray-100 rounded-full my-1 mx-1 px-2 py-1;
	}

	.card_tag_selected {
		@apply text-gray-900 bg-gray-200;
	}
</style>
